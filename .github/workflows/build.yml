name: üß± Build & Test ProgramEle (Qt6 Offscreen Safe)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # --- 1Ô∏è‚É£ Pobranie repozytorium ---
      - name: Checkout repository
        uses: actions/checkout@v4

      # --- 2Ô∏è‚É£ Instalacja Qt6 i zale≈ºno≈õci ---
      - name: Install Qt6 and dependencies
        run: |
          sudo apt update -y
          sudo apt install -y \
            qt6-base-dev qt6-base-dev-tools qt6-tools-dev qt6-tools-dev-tools \
            qt6-declarative-dev qt6-pdf-dev cmake ninja-build g++
          echo "‚úÖ Qt6 installed."

      # --- 3Ô∏è‚É£ Konfiguracja projektu ---
      - name: Configure with CMake
        run: |
          cmake -S . -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_PREFIX_PATH=/usr/lib/x86_64-linux-gnu/cmake/Qt6
          echo "‚úÖ CMake configuration done."

      # --- 4Ô∏è‚É£ Kompilacja projektu ---
      - name: Build project
        run: |
          echo "üõ†Ô∏è Building..."
          cmake --build build --parallel || { echo "‚ùå Build failed"; exit 1; }
          echo "‚úÖ Build completed."

      # --- 5Ô∏è‚É£ Test g≈Ç√≥wnej aplikacji (headless) ---
      - name: Run main binary (offscreen)
        env:
          QT_QPA_PLATFORM: offscreen
        run: |
          if [ -f build/ProgramEle ]; then
            echo "üöÄ Launching ProgramEle (offscreen)..."
            xvfb-run -a ./build/ProgramEle --version || echo "‚ÑπÔ∏è GUI output suppressed."
          else
            echo "‚ö†Ô∏è ProgramEle binary not found."
          fi

      # --- 6Ô∏è‚É£ Test jednostkowy CODEX (headless logic) ---
      - name: Run Codex headless logic test
        env:
          QT_QPA_PLATFORM: offscreen
        run: |
          if [ -f build/TestProgramEle ]; then
            echo "üß™ Running TestProgramEle (offscreen)..."
            ./build/TestProgramEle || { echo "‚ùå TestProgramEle failed"; exit 1; }
            echo "‚úÖ TestProgramEle finished successfully."
          else
            echo "‚ö†Ô∏è TestProgramEle binary not found ‚Äî skipping test."
            ls -R build || true
          fi

      # --- 7Ô∏è‚É£ Publikacja artefakt√≥w (binarki do pobrania) ---
      - name: Upload build artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ProgramEle-artifacts
          path: |
            build/ProgramEle*
            build/TestProgramEle*
          if-no-files-found: warn

      # --- 8Ô∏è‚É£ Zako≈Ñczenie ---
      - name: Build complete
        run: echo "üéâ Qt6 build & test pipeline completed successfully!"
