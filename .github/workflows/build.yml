name: üß± Build and Test ProgramEle (Qt 6)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # --- Pobranie repozytorium ---
      - name: Checkout repository
        uses: actions/checkout@v4

      # --- Instalacja ≈õrodowiska Qt6 i narzƒôdzi budowania ---
      - name: Install Qt6 and dependencies
        run: |
          sudo apt update
          sudo apt install -y \
            qt6-base-dev \
            qt6-base-dev-tools \
            qt6-tools-dev \
            qt6-tools-dev-tools \
            qt6-declarative-dev \
            qt6-pdf-dev \
            cmake ninja-build g++
          echo "‚úÖ Qt6 successfully installed"

      # --- Diagnostyka Qt (opcjonalna, pokazuje konfiguracjƒô) ---
      - name: Verify Qt installation
        run: |
          qmake6 -v || echo "‚ö†Ô∏è qmake6 not found (ok if using pure CMake)"
          ls -l /usr/lib/x86_64-linux-gnu/cmake/Qt6* || true

      # --- Konfiguracja projektu przez CMake ---
      - name: Configure project (CMake)
        run: |
          cmake -S . -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_PREFIX_PATH=/usr/lib/x86_64-linux-gnu/cmake/Qt6

      # --- Kompilacja projektu ---
      - name: Build project
        run: |
          cmake --build build --parallel
          echo "‚úÖ ProgramEle built successfully"

      # --- Test podstawowy (czy g≈Ç√≥wny plik binarny siƒô buduje) ---
      - name: Run main binary (headless)
        run: |
          if [ -f build/ProgramEle ]; then
            echo "Binary found, running smoke test..."
            xvfb-run -a ./build/ProgramEle --version || echo "‚ÑπÔ∏è GUI app cannot display output (expected)"
          else
            echo "‚ö†Ô∏è ProgramEle binary not found!"
            ls -R build
          fi

      # --- Uruchomienie testu headless (dla CODEX) ---
      - name: Run Codex headless logic test
        run: |
          if [ -f build/TestProgramEle ]; then
            echo "üß™ Running Codex headless logic test..."
            ./build/TestProgramEle
          else
            echo "‚ö†Ô∏è TestProgramEle binary not found!"
            ls -R build
          fi

      # --- Publikacja artefakt√≥w (binarek) ---
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ProgramEle-build
          path: |
            build/ProgramEle*
            build/TestProgramEle*
          if-no-files-found: ignore

      # --- Zako≈Ñczenie procesu ---
      - name: Build finished
        run: echo "üéâ Qt6 build & test pipeline completed successfully!"
