name: üß± Build and Test ProgramEle (Qt 6 - Offscreen Safe)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # --- 1Ô∏è‚É£ Pobranie repozytorium ---
      - name: Checkout repository
        uses: actions/checkout@v4

      # --- 2Ô∏è‚É£ Instalacja ≈õrodowiska Qt6 i narzƒôdzi budowania ---
      - name: Install Qt6 and dependencies
        run: |
          sudo apt update -y
          sudo apt install -y \
            qt6-base-dev \
            qt6-base-dev-tools \
            qt6-tools-dev \
            qt6-tools-dev-tools \
            qt6-declarative-dev \
            qt6-pdf-dev \
            cmake ninja-build g++
          echo "‚úÖ Qt6 and build tools installed successfully."

      # --- 3Ô∏è‚É£ Diagnostyka Qt6 (sprawdzenie dostƒôpno≈õci) ---
      - name: Verify Qt installation
        run: |
          echo "üß© Checking Qt6 installation paths..."
          qmake6 -v || echo "‚ÑπÔ∏è qmake6 not found (fine for CMake-only builds)"
          ls -d /usr/lib/x86_64-linux-gnu/cmake/Qt6* || echo "‚ö†Ô∏è Qt6 cmake modules not found!"

      # --- 4Ô∏è‚É£ Konfiguracja projektu przez CMake ---
      - name: Configure CMake project
        run: |
          echo "‚öôÔ∏è Configuring CMake project..."
          cmake -S . -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_PREFIX_PATH=/usr/lib/x86_64-linux-gnu/cmake/Qt6
          echo "‚úÖ CMake configuration completed."

      # --- 5Ô∏è‚É£ Kompilacja projektu ---
      - name: Build project
        run: |
          echo "üõ†Ô∏è Building project..."
          cmake --build build --parallel || { echo "‚ùå Build failed"; exit 1; }
          echo "‚úÖ ProgramEle built successfully."

      # --- 6Ô∏è‚É£ Sprawdzenie binarki g≈Ç√≥wnej ---
      - name: Check main binary
        run: |
          if [ -f build/ProgramEle ]; then
            echo "‚úÖ Found main binary: ProgramEle"
          else
            echo "‚ö†Ô∏è Main binary not found ‚Äî listing contents of build directory:"
            ls -R build || true
          fi

      # --- 7Ô∏è‚É£ Test podstawowy (g≈Ç√≥wna aplikacja w trybie headless) ---
      - name: Run main binary (headless test)
        env:
          QT_QPA_PLATFORM: offscreen
        run: |
          if [ -f build/ProgramEle ]; then
            echo "üöÄ Running headless smoke test..."
            xvfb-run -a ./build/ProgramEle --version || echo "‚ÑπÔ∏è GUI app cannot display output (expected)."
          else
            echo "‚ö†Ô∏è ProgramEle binary missing, skipping GUI run."
          fi

      # --- 8Ô∏è‚É£ Test headless logic (dla CODEX, bez GUI) ---
      - name: Run Codex headless logic test (offscreen)
        env:
          QT_QPA_PLATFORM: offscreen
        run: |
          if [ -f build/TestProgramEle ]; then
            echo "üß™ Running Codex headless logic test (offscreen)..."
            ./build/TestProgramEle || { echo '‚ùå TestProgramEle failed'; exit 1; }
            echo "‚úÖ Headless logic test finished successfully."
          else
            echo "‚ö†Ô∏è TestProgramEle binary not found ‚Äî skipping test."
            ls -R build || true
          fi

      # --- 9Ô∏è‚É£ Publikacja artefakt√≥w (binarki do pobrania) ---
      - name: Upload build artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ProgramEle-build
          path: |
            build/ProgramEle*
            build/TestProgramEle*
          if-no-files-found: warn

      # --- üîü Zako≈Ñczenie ---
      - name: Build finished
        run: echo "üéâ Qt6 build & test pipeline completed successfully!"
